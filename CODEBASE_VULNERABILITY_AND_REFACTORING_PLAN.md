# Codebase Vulnerability & Refactoring Plan (Agent-Only Focus)

Date: 2025-08-15
Scope: Stealth behavior inside the agent runtime (timing, motion, sequencing, planning, and error simulation). No changes to user/system/browser environment.

Important: The agent does not modify the user’s OS/Chrome install or persistent profile. All mitigations below operate at the agent level (timings, movement, plan ordering) and are ephemeral.

## Executive Summary
We reduce predictability by introducing bounded, realistic variance purely in the agent’s own operation: cognitive delays, movement kinematics, scroll physics, action sequencing, and error simulation. We remove network/header/viewport jitter from scope per directive, keeping the execution surface strictly behavioral.

## Risks and Mitigations (Behavioral)

1) Fixed timing envelopes (deliberation, keystrokes, settle times)
- Impact: Robotic regularity in action/typing cadence
- Mitigation: Maintain distribution-driven timings with subtle per-run seed; remove crisp caps by slightly varying floors/ceilings while keeping human-realistic bounds.
- Work: `CognitiveTimingEngine.get_deliberation_delay/get_keystroke_interval/get_mouse_settle_time`

2) Mouse motion determinism (paths and velocity)
- Impact: Repeated trajectories and constant velocity profiles
- Mitigation: Preserve Bézier + velocity profile but add micro-variance in acceleration curve, tremor, occasional overshoot, and correction rates bounded by profile.
- Work: `BiometricMotionEngine.generate_movement_path/_apply_velocity_profile/should_overshoot_target`

3) Deterministic interaction sequencing
- Impact: Identical order of exploration/primary/post actions
- Mitigation: Allow small, realistic reordering of exploration steps, optional micro no-op hovers, and tiny pre/post delays. Keep it bounded so plans remain coherent.
- Work: `HumanInteractionEngine._plan_exploration_sequence/_plan_post_action_behavior`

4) Error-free “perfect” flows
- Impact: Unrealistic absence of human errors
- Mitigation: Low-probability, context-plausible errors with immediate correction (wrong focus, brief premature typing, small typos) tied to profile stress/familiarity.
- Work: `HumanInteractionEngine._should_simulate_error/_plan_error_simulation`

5) URL typing hesitation monoculture
- Impact: Same pause profile before submit
- Mitigation: Keep hesitation distribution but salt per run; ensure deliberate URL timing vs normal text remains distinct.
- Work: `StealthManager.execute_human_like_navigation`

## Implementation Phases (Behavioral Only)

- Phase A: Timing polish
  - Subtle per-run seed to nudge timing distributions; maintain human bounds.
- Phase B: Motion polish
  - Minor variability in acceleration curve and micro-corrections, already present; ensure no crisp limits remain.
- Phase C: Sequencing variance
  - Small exploration step shuffles and optional micro-hovers; bounded counts.
- Phase D: Error realism
  - Keep small error rates tied to stress/familiarity; ensure quick corrections.

## Flags Summary (Behavioral)
- `STEALTH_ENTROPY=true` (enables bounded behavior variance)
- `STEALTH_BEHAVIORAL_PLANNING=true` (optional planning-driven interaction)
- `STEALTH_PAGE_EXPLORATION=true` (optional pre-action exploration)
- `STEALTH_ERROR_SIMULATION=true` (optional low-rate error simulation)

## Test Notes
- Validate with exploration and error-simulation tests.
- Ensure bounds keep actions timely and stable under CI.

## Backout
- Toggle off behavioral flags to revert to stable, deterministic behavior quickly.
